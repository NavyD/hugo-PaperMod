{{- define "main" }}

{{- if .Title }}
<header class="page-header">
    <h1>{{ .Title }}</h1>
    {{- if .Description }}
    <div class="post-description">
        {{ .Description }}
    </div>
    {{- end }}
</header>
{{- end }}

<ul class="terms-tags">
    {{- $type := .Type }}
    {{- range $key, $value := .Data.Terms.Alphabetical }}
    {{- $name := .Name }}
    {{- $count := .Count }}
    {{- with site.GetPage (printf "/%s/%s" $type $name) }}
    <li>
        <a href="{{ .Permalink }}">{{ .Name }} <sup><strong><sup>{{ $count }}</sup></strong></sup> </a>
    </li>
    {{- end }}
    {{- end }}
</ul>

<div class="widget-wrap">
    {{- with .Site.Data.l10n.widgets.tags.title }}
    <h3 class="widget-title">
        {{.}}
    </h3>
    {{- end }}

    {{ if not (eq (len $.Site.Taxonomies.tags) 0) }}
    {{ $fontUnit := "rem" }}
    {{ $largestFontSize := 2.0 }}
    {{ $largestFontSize := 2.5 }}
    {{ $smallestFontSize := 1.0 }}
    {{ $fontSpread := sub $largestFontSize $smallestFontSize }}
    {{ $max := add (len (index $.Site.Taxonomies.tags.ByCount 0).Pages) 1 }}
    {{ $min := len (index $.Site.Taxonomies.tags.ByCount.Reverse 0).Pages }}
    {{ $spread := sub $max $min }}
    {{ $fontStep := div $fontSpread $spread }}

    <ul class="term-cloud" style="padding: 5px 15px">
        {{ range $name, $taxonomy := $.Site.Taxonomies.tags }}
        {{ $currentTagCount := len $taxonomy.Pages }}
        {{ $currentFontSize := (add $smallestFontSize (mul (sub $currentTagCount $min) $fontStep) ) }}
        {{ $count := len $taxonomy.Pages }}
        {{ $weigth := div (sub (math.Log $count) (math.Log $min)) (sub (math.Log $max) (math.Log $min)) }}
        {{ $currentFontSize := (add $smallestFontSize (mul (sub $largestFontSize $smallestFontSize) $weigth) ) }}
        <!--Current font size: {{$currentFontSize}}-->
        <li class="term-items">
            <a href="{{ printf " /%s/%s" $.Type $name }}"
                style="font-size:{{$currentFontSize}}{{$fontUnit}}">{{$name}}</a>
        </li>
        {{ end }}
    </ul>
    {{ end }}
</div>

<script>
    // ref: [Hugo 사이트에 Weighted Tag Cloud 추가하기](https://notes.harues.com/posts/hugo-weighted-tag-cloud/)
    window.addEventListener('load', () => {
        const shuffle = array => {
            let shuffled = [...array],
                currIndex = array.length,
                tempValue,
                randIndex

            while (currIndex) {
                randIndex = Math.floor(Math.random() * currIndex)
                currIndex--

                tempValue = shuffled[currIndex]
                shuffled[currIndex] = shuffled[randIndex]
                shuffled[randIndex] = tempValue
            }
            return shuffled
        }

        let termClouds = document.querySelectorAll('.term-cloud')

        for (let termCloud of termClouds) {
            if (termCloud) {
                let terms = termCloud.querySelectorAll('.term-cloud li')
                shuffle(terms).forEach(term => term.parentElement.appendChild(term))
            }
        }
    });
</script>

{{- end }}{{/* end main */ -}}